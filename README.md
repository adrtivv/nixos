# About

System configuration managed by nix. It follows **the dendritic pattern**. More information can be found at these links:

1. https://github.com/Doc-Steve/dendritic-design-with-flake-parts/wiki
2. https://github.com/mightyiam/dendritic

# Some sops information

This configuration makes use of `sops` with `age` asymmetric encryption to handle its secrets. The `secrets.yaml` file at the root directory of this repository contains the age encrypted secrets.

To encrypt the secrets any one of the `age` public keys specified in `.sops.yaml` file at the root directory of this repository are used.

To decrypt the secrets any one of the `age` private keys present at `/var/lib/sops-nix/keys.txt` on a host or `/home/<user_name>/.config/sops/age/keys.txt` in the home directory of a user `<user_name>`, both specified in `.sops.yaml` file at the root directory of this repository are used.

The age public and private keys for the user with `<user_name>` are generated with `x25519` algorithm and they are host independent.

The age public and private keys for the hosts are generated by deriving the `x25519` equivalent of the `ed25519` ssh keys already present on those hosts at the `/etc/ssh` directory.

To generate age key pair run the command below:
```bash
age-keygen -o ~/.config/sops/keys.txt
```

To get age public key run the command below:
```bash
age-keygen -y ~/.config/sops/keys.txt
```

To derive age public key from host ssh public key run the command below:
```bash
cat /etc/ssh/ssh_host_ed25519_key.pub | ssh-to-age 
```

To create the hashed user password run the command below:
```bash
mkpasswd -s
```

Whenever a new age public key is added to, removed from or modified in the `keys` field in the `.sops.yaml` file at the root directory of this repository run the command below to re-encrypt the `secrets.yaml` file with the new state of the `.sops.yaml` file:
```bash
sops updatekeys ./secrets.yaml
```
